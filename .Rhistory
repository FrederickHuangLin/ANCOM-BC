scale_shape_manual(name=NULL, values=c(1, 17))+
labs(x="", y="Centered Deviance")+
theme_bw()+
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.ticks.x=element_blank(),
axis.text.x = element_blank(),
legend.position = c(0.36, 0.85),
legend.direction = "horizontal", legend.box = "vertical")
p
View(ANCOM_BC)
rm(list = ls())
library(tidyverse)
library(phyloseq)
library(pander)
panderOptions('table.caption.prefix', NULL)
panderOptions('table.continues', NULL)
panderOptions('table.emphasize.rownames', FALSE)
gg_color_hue=function(n){
hues = seq(15, 375, length = n + 1)
hcl(h = hues, l = 65, c = 100)[1:n]
}
source("ancom_bc_v1.1.R")
source("sim_data_poi_gam_two_grp.R")
View(ANCOM_BC)
n.taxa=500; n.samp.grp1=30; n.samp.grp2=30; low.abn=50; med.abn=200; high.abn=10000
prop.diff=0.25; abn.seed=12; obs.seed=13; struc.zero.prop=0; out.zero.prop=0
balanced.micro.load = FALSE; balanced.lib.size = TRUE; samp.frac = "large"
test.dat=abn.tab.gen1(n.taxa, n.samp.grp1, n.samp.grp2, low.abn, med.abn, high.abn, prop.diff,
abn.seed, obs.seed, struc.zero.prop, out.zero.prop,
balanced.micro.load, balanced.lib.size, samp.frac)
obs.abn=test.dat$obs.abn
meta.data=cbind(Sample.ID=paste0("sub", seq(n.samp.grp1+n.samp.grp2)),
group=rep(c(1, 2), c(n.samp.grp1, n.samp.grp2)))
# ANCOM-BC
# Pre-processing
feature.table=obs.abn; sample.var="Sample.ID"; group.var="group"
zero.cut=0.90; lib.cut=1000; neg.lb=FALSE
pre.process=feature_table_pre_process(feature.table, meta.data, sample.var,
group.var, zero.cut, lib.cut, neg.lb)
feature.table=pre.process$feature.table
group.name=pre.process$group.name
group.ind=pre.process$group.ind
struc.zero=pre.process$structure.zeros
# Paras for ANCOM-BC
grp.name=group.name; grp.ind=group.ind; adj.method="bonferroni"
tol.EM=1e-5; max.iterNum=100; perNum = 1000; alpha=0.05
out<-try(ANCOM_BC(feature.table, grp.name, grp.ind, struc.zero, adj.method,
tol.EM, max.iterNum, perNum, alpha), silent = T)
if (inherits(out, "try-error")){
ANCOM.BC=rep(NA, n.samp.grp1+n.samp.grp2)
}else{ANCOM.BC=out$d}
sub.keep=match(names(ANCOM.BC), colnames(obs.abn))
# True value
ACTUAL=log(test.dat$samp.frac); ACTUAL=ACTUAL[sub.keep]
countdata=test.dat$obs.abn
zero.threshold=0.90
taxa.info.ind=apply(countdata, 1, function(x) sum(x==0)/ncol(countdata))
countdata=countdata[which(taxa.info.ind<zero.threshold), ]+1L
# UQ: Upper quartile normalization
groupdata=factor(rep(c(1, 2), c(n.samp.grp1, n.samp.grp2)))
feature_table=countdata+1
dds=edgeR::DGEList(counts = feature_table, group = groupdata)
dds=edgeR::calcNormFactors(dds, method="upperquartile")
UQ1=dds$samples$norm.factors*colSums(feature_table, na.rm = T); UQ1=log(UQ1)[sub.keep]
UQ2=dds$samples$norm.factors; UQ2=log(UQ2)[sub.keep]
# TMM: Trimed mean of m-values
dds=edgeR::DGEList(counts = feature_table, group = groupdata)
dds=edgeR::calcNormFactors(dds, method="TMM")
TMM1=dds$samples$norm.factors*colSums(feature_table, na.rm = T); TMM1=log(TMM1)[sub.keep]
TMM2=dds$samples$norm.factors; TMM2=log(TMM2)[sub.keep]
# CSS: Cumulative-sum scaling
meta.data=data.frame(group=rep(c(1, 2), c(n.samp.grp1, n.samp.grp2)))
rownames(meta.data)=paste0("sub", seq(n.samp.grp1+n.samp.grp2))
feature_table=countdata+1
phenotypeData = Biobase::AnnotatedDataFrame(meta.data)
obj = metagenomeSeq::newMRexperiment(countdata, phenoData=phenotypeData, featureData=NULL)
# Calculating normalization factors
p = metagenomeSeq::cumNormStatFast(obj)
obj = metagenomeSeq::cumNorm(obj, p = p)
CSS = metagenomeSeq::normFactors(obj); CSS=log(CSS)[sub.keep]
# MED: Median normalization
coldata=data.frame(group=as.factor(rep(c(1, 2), c(n.samp.grp1, n.samp.grp2))))
rownames(coldata)=paste0("sub", seq(n.samp.grp1+n.samp.grp2))
feature_table=countdata+1
count.table=DESeq2::DESeqDataSetFromMatrix(countData = feature_table,
colData = coldata, design = ~ group)
dds<-try(DESeq2::DESeq(count.table, quiet = T), silent = T)
if (inherits(dds, "try-error")){
MED=rep(NA, n.samp.grp1+n.samp.grp2)[sub.keep]
}else{
MED=DESeq2::sizeFactors(dds)
MED=log(MED)[sub.keep]}
# TSS: Total-sum scaling
TSS=colSums(countdata, na.rm = T); TSS=log(TSS)[sub.keep]
norm.df=data.frame(ACTUAL, ANCOM.BC, UQ1, UQ2, TMM1, TMM2, CSS, MED, TSS,
group=rep(c("Group1", "Group2"), sapply(group.ind, length)))
norm.df=norm.df%>%mutate(D.ANCOM.BC = ACTUAL - ANCOM.BC,
D.UQ1 = ACTUAL - UQ1, D.UQ2 = ACTUAL - UQ2,
D.TMM1 = ACTUAL - TMM1, D.TMM2 = ACTUAL - TMM2,
D.CSS = ACTUAL - CSS, D.MED = ACTUAL - MED,
D.TSS = ACTUAL - TSS,
CD.ANCOM.BC = scale(D.ANCOM.BC, scale = F),
CD.UQ1 = scale(D.UQ1, scale = F), CD.UQ2 = scale(D.UQ2, scale = F),
CD.TMM1 = scale(D.TMM1, scale = F), CD.TMM2 = scale(D.TMM2, scale = F),
CD.CSS = scale(D.CSS, scale = F), CD.MED = scale(D.MED, scale = F),
CD.TSS = scale(D.TSS, scale = F))
p.df = norm.df%>%gather(key = "method", value = "value", CD.ANCOM.BC:CD.TSS)
p.df$method = factor(p.df$method,
levels = c("CD.ANCOM.BC", "CD.UQ1", "CD.TMM1",
"CD.CSS", "CD.MED", "CD.UQ2", "CD.TMM2", "CD.TSS"))
norm.var = p.df%>%group_by(method)%>%
summarise(method.var = signif(var(value), 2))%>%
mutate(method.abb = c("ANCOM-BC", "ELib-UQ", "ELib-TMM", "CSS", "MED", "UQ", "TMM", "TSS"),
label = paste0(method.abb, " (", method.var, ")"))
p=ggplot(p.df, aes(x=method, y=value, color=method))+
scale_y_continuous(breaks = seq(-0.4, 0.4, 0.2), limits = c(-0.6, 0.9))+
geom_boxplot()+geom_hline(yintercept = 0, linetype="dotted")+
geom_jitter(color="gray28", position=position_jitter(0.2), aes(shape=group))+
scale_color_manual(name=NULL,
label=norm.var$label,
values = gg_color_hue(8))+
scale_shape_manual(name=NULL, values=c(1, 17))+
labs(x="", y="Centered Deviance")+
theme_bw()+
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.ticks.x=element_blank(),
axis.text.x = element_blank(),
legend.position = c(0.36, 0.85),
legend.direction = "horizontal", legend.box = "vertical")
p
View(ANCOM_BC)
rm(list = ls())
library(tidyverse)
library(nloptr)
library(phyloseq)
library(stringr)
library(RColorBrewer)
library(ggpubr)
library(ggforce)
library(limma)
library(vegan)
library(MASS)
library(pander)
panderOptions('table.caption.prefix', NULL)
panderOptions('table.continues', NULL)
panderOptions('table.emphasize.rownames', FALSE)
source("ancom_bc_v1.1.R")
source("ancom_v1.0.R")
# Meta data
meta_data=read_tsv("../data/global_gut/global_gut_metadata.txt")
meta_data=meta_data%>%transmute(Sample.ID=`#SampleID`, age=AGE, sex=SEX, country=COUNTRY)%>%
arrange(Sample.ID)
meta_data=meta_data[complete.cases(meta_data), ]
meta_data$age=as.numeric(meta_data$age)
meta_data$country=recode(meta_data$country, `GAZ:Malawi` = "MA",
`GAZ:United States of America` = "US", `GAZ:Venezuela` = "VEN")
# Taxonomy
taxonomy=read_tsv("../data/global_gut/global_gut_taxonomy.txt")
taxonomy=taxonomy%>%rowwise()%>%
mutate(genus_name=paste(Phylum, Genus, sep = ";"))
# OTU table
otu_table=read_tsv("../data/global_gut/global_gut_otu.txt")
otu_table=otu_table[, -532]
otu_table$OTU_ID=taxonomy$genus_name[match(otu_table$OTU_ID, taxonomy$OTU_ID)]
otu_table=as.data.frame(otu_table)
otu_table[, -1]=apply(otu_table[, -1], 2, as.numeric)
# Aggregate into genus level
genus_table=otu_table%>%group_by(OTU_ID)%>%
summarise_all(sum)
non_info_pos=grep("\\g__\\b", genus_table$OTU_ID) # Exact match
genus_table=genus_table[-non_info_pos, ]
genus_table=as.data.frame(genus_table)
# Subset meta data
meta.data=meta_data%>%filter(country%in%c("MA", "VEN"))
meta.data$country=as.character(meta.data$country)
# Subset OTU table
obs.abn=genus_table
rownames(obs.abn)=obs.abn$OTU_ID
obs.abn=obs.abn[, -1]
obs.abn=obs.abn[, meta.data$Sample.ID]
# Recode sample ID
meta.data$Sample.ID=seq(nrow(meta.data))
colnames(obs.abn)=seq(nrow(meta.data))
feature.table=obs.abn; sample.var="Sample.ID"; group.var="country";
zero.cut=0.90; lib.cut=1000; neg.lb=TRUE
pre.process=feature_table_pre_process(feature.table, meta.data, sample.var,
group.var, zero.cut, lib.cut, neg.lb)
feature.table=pre.process$feature.table
library.size=pre.process$library.size
group.name=pre.process$group.name
group.ind=pre.process$group.ind
struc.zero=pre.process$structure.zeros
# Paras for ANCOM-BC
grp.name=group.name; grp.ind=group.ind; adj.method="BH"
tol.EM=1e-5; max.iterNum=100; perNum=1000; alpha=0.05
# Run ANCOM-BC
out=ANCOM_BC(feature.table, grp.name, grp.ind, struc.zero, adj.method,
tol.EM, max.iterNum, perNum, alpha)
ancom.bc=out$d
y.ancom.bc=t(t(log(out$feature.table+1))-ancom.bc)
y.ancom.bc=y.ancom.bc+abs(min(y.ancom.bc, na.rm = T))
dist.ancom.bc=vegdist(t(y.ancom.bc), method="bray", na.rm = T)
fit.ancom.bc=isoMDS(dist.ancom.bc, k=2)
mds.xy.ancom.bc=data.frame(method = "ANCOM-BC", fit.ancom.bc$points)
mds.xy.ancom.bc$country=meta.data$country[match(colnames(out$feature.table), meta.data$Sample.ID)]
countdata=obs.abn
zero.threshold=0.90
taxa.info.ind=apply(countdata, 1, function(x) sum(x==0)/ncol(countdata))
countdata=countdata[which(taxa.info.ind<zero.threshold), ]+1L
groupdata=meta.data$country
dds=edgeR::DGEList(counts = countdata, group = groupdata)
dds=edgeR::calcNormFactors(dds, method="upperquartile")
UQ1=dds$samples$norm.factors*colSums(countdata, na.rm = T)
y.uq1=t(t(log(countdata))-log(UQ1))
y.uq1=y.uq1+abs(min(y.uq1))
dist.uq1=vegdist(t(y.uq1), method="bray", na.rm = T)
fit.uq1=isoMDS(dist.uq1, k=2)
mds.xy.uq1=data.frame(method = "ELib-UQ", fit.uq1$points, country = meta.data$country)
dds=edgeR::DGEList(counts = countdata, group = groupdata)
dds=edgeR::calcNormFactors(dds, method="TMM")
TMM1=dds$samples$norm.factors*colSums(countdata, na.rm = T)
y.tmm1=t(t(log(countdata))-log(TMM1))
y.tmm1=y.tmm1+abs(min(y.tmm1))
dist.tmm1=vegdist(t(y.tmm1), method="bray", na.rm = T)
fit.tmm1=isoMDS(dist.tmm1, k=2)
mds.xy.tmm1=data.frame(method = "ELib-TMM", fit.tmm1$points, country = meta.data$country)
rownames(meta.data)=meta.data$Sample.ID
phenotypeData = Biobase::AnnotatedDataFrame(meta.data)
obj = metagenomeSeq::newMRexperiment(countdata, phenoData=phenotypeData, featureData=NULL)
# Calculating normalization factors
obj = metagenomeSeq::cumNorm(obj)
CSS = metagenomeSeq::normFactors(obj)
y.css=t(t(log(countdata))-log(CSS))
y.css=y.css+abs(min(y.css))
dist.css=vegdist(t(y.css), method="bray", na.rm = T)
fit.css=isoMDS(dist.css, k=2)
mds.xy.css=data.frame(method = "CSS", fit.css$points, country = meta.data$country)
coldata=meta.data
count.table=DESeq2::DESeqDataSetFromMatrix(countData = countdata,
colData = coldata, design = ~ country)
dds=DESeq2::DESeq(count.table, quiet = TRUE)
MED=DESeq2::sizeFactors(dds)
y.med=t(t(log(countdata))-log(MED))
y.med=y.med+abs(min(y.med))
dist.med=vegdist(t(y.med), method="bray", na.rm = T)
fit.med=isoMDS(dist.med, k=2)
mds.xy.med=data.frame(method = "MED", fit.med$points, country = meta.data$country)
groupdata=meta.data$country
dds=edgeR::DGEList(counts = countdata, group = groupdata)
dds=edgeR::calcNormFactors(dds, method="upperquartile")
UQ2=dds$samples$norm.factors
y.uq2=t(t(log(countdata))-log(UQ2))
y.uq2=y.uq2+abs(min(y.uq2))
dist.uq2=vegdist(t(y.uq2), method="bray", na.rm = T)
fit.uq2=isoMDS(dist.uq2, k=2)
mds.xy.uq2=data.frame(method = "UQ", fit.uq2$points, country = meta.data$country)
dds=edgeR::DGEList(counts = countdata, group = groupdata)
dds=edgeR::calcNormFactors(dds, method="TMM")
TMM2=dds$samples$norm.factors
y.tmm2=t(t(log(countdata))-log(TMM2))
y.tmm2=y.tmm2+abs(min(y.tmm2))
dist.tmm2=vegdist(t(y.tmm2), method="bray", na.rm = T)
fit.tmm2=isoMDS(dist.tmm2, k=2)
mds.xy.tmm2=data.frame(method = "TMM", fit.tmm2$points, country = meta.data$country)
TSS=colSums(countdata, na.rm = T)
y.tss=t(t(log(countdata))-log(TSS))
y.tss=y.tss+abs(min(y.tss))
dist.tss=vegdist(t(y.tss), method="bray", na.rm = T)
fit.tss=isoMDS(dist.tss, k=2)
mds.xy.tss=data.frame(method = "TSS", fit.tss$points, country = meta.data$country)
ss_compute=function(x){
x=as.matrix(x)
ss=sum(t(t(x)-colMeans(x, na.rm = T))^2, na.rm = T)
return(ss)
}
mds.xy.ancom.bc=mds.xy.ancom.bc%>%mutate(scale_x1=scale(X1), scale_x2=scale(X2))
mds.xy.uq1=mds.xy.uq1%>%mutate(scale_x1=scale(X1), scale_x2=scale(X2))
mds.xy.tmm1=mds.xy.tmm1%>%mutate(scale_x1=scale(X1), scale_x2=scale(X2))
mds.xy.css=mds.xy.css%>%mutate(scale_x1=scale(X1), scale_x2=scale(X2))
mds.xy.med=mds.xy.med%>%mutate(scale_x1=scale(X1), scale_x2=scale(X2))
mds.xy.uq2=mds.xy.uq2%>%mutate(scale_x1=scale(X1), scale_x2=scale(X2))
mds.xy.tmm2=mds.xy.tmm2%>%mutate(scale_x1=scale(X1), scale_x2=scale(X2))
mds.xy.tss=mds.xy.tss%>%mutate(scale_x1=scale(X1), scale_x2=scale(X2))
mds.list=list(mds.xy.ancom.bc, mds.xy.uq1, mds.xy.tmm1, mds.xy.css,
mds.xy.med, mds.xy.uq2, mds.xy.tmm2, mds.xy.tss)
ssb.df=data.frame(method=c("ANCOM-BC", "ELib-UQ", "ELib-TMM", "CSS", "MED", "UQ", "TMM", "TSS"), ssb = NA)
for (i in 1:length(mds.list)) {
method=mds.list[[i]]
sst=ss_compute(method%>%dplyr::select(scale_x1, scale_x2))
ssw=ss_compute(method%>%filter(country=="MA")%>%dplyr::select(scale_x1, scale_x2))+
ss_compute(method%>%filter(country=="VEN")%>%dplyr::select(scale_x1, scale_x2))
ssb=sst-ssw
ssb.df[i, "ssb"]=ssb
}
txt.df = data.frame(X1=0.2, X2=0.25, ssb.df)
txt.df$ssb = paste0("SSB = ", round(txt.df$ssb, 0))
p.df = rbind(mds.xy.ancom.bc, mds.xy.uq1, mds.xy.tmm1, mds.xy.css,
mds.xy.med, mds.xy.uq2, mds.xy.tmm2, mds.xy.tss)
txt.df$method = factor(txt.df$method, levels = c("ANCOM-BC", "ELib-UQ", "ELib-TMM", "CSS",
"MED", "UQ", "TMM", "TSS"))
p.df$method = factor(p.df$method, levels = c("ANCOM-BC", "ELib-UQ", "ELib-TMM", "CSS",
"MED", "UQ", "TMM", "TSS"))
p=ggplot(p.df, aes(X1, X2, color = country)) + geom_point(size = 0.3) +
facet_wrap(.~method, nrow = 2)+scale_y_continuous(limits = c(-0.3, 0.3))+
labs(x="First NMDS coordinate", y="Second NMDS coordinate")+
scale_color_discrete(name="", breaks=c("MA", "VEN"), labels = c("Malawi", "Venezuela"))+
theme_bw()+
theme(plot.title = element_text(hjust = 0.5),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.position = "bottom",
strip.background = element_rect(fill="white"))+
guides(color = guide_legend(override.aes = list(size=3)))+
geom_text(data = txt.df, mapping = aes(x = X1, y = X2, label = ssb, color = NULL,group= NULL))
p
rm(list = ls())
library(readxl)
library(tidyverse)
library(nloptr)
library(phyloseq)
library(stringr)
library(ggpubr)
library(magrittr)
library(qwraps2)
library(pander)
panderOptions('table.caption.prefix', NULL)
panderOptions('table.continues', NULL)
panderOptions('table.emphasize.rownames', FALSE)
source("ancom_bc_v1.1.R")
ma_us_0_2=read_csv("../data/global_gut/ma_us_phylum_age2.csv")
ma_us_18_40=read_csv("../data/global_gut/ma_us_phylum_age18_40.csv")
ma_us_phyla=unique(c(ma_us_0_2$phylum, ma_us_18_40$phylum))
ma_us_0_2=ma_us_0_2%>%transmute(phylum, log.fold.change=`log fold change (MA - US)`,
se=se, ci.lo=ci.lo.adj, ci.up=ci.up.adj,
struc.zero=ifelse(se==0, 1, 0),
q.val, age.group = "Infants",
star=ifelse(q.val<.001, "***",
ifelse(q.val<.01, "**",
ifelse(q.val<.05, "*", ""))))
if(length(setdiff(ma_us_phyla, ma_us_0_2$phylum))>0){
ma_us_0_2.1=data.frame(phylum=setdiff(ma_us_phyla, ma_us_0_2$phylum),
log.fold.change=0, se=0, ci.lo=0, ci.up=0,
struc.zero=1, q.val=1, age.group="Infants", star="")
ma_us_0_2=rbind(ma_us_0_2, ma_us_0_2.1)
}
ma_us_18_40=ma_us_18_40%>%transmute(phylum, log.fold.change=`log fold change (MA - US)`,
se=se, ci.lo=ci.lo.adj, ci.up=ci.up.adj,
struc.zero=ifelse(se==0, 1, 0),
q.val, age.group = "Adults",
star=ifelse(q.val<.001, "***",
ifelse(q.val<.01, "**",
ifelse(q.val<.05, "*", ""))))
if(length(setdiff(ma_us_phyla, ma_us_18_40$phylum))>0){
ma_us_18_40.1=data.frame(phylum=setdiff(ma_us_phyla, ma_us_18_40$phylum),
log.fold.change=0, se=0, ci.lo=0, ci.up=0,
struc.zero=1, q.val=1, age.group="Adults", star="")
ma_us_18_40=rbind(ma_us_18_40, ma_us_18_40.1)
}
dat.fig_ma_us=rbind(ma_us_0_2, ma_us_18_40)
dat.fig_ma_us$age.group=factor(dat.fig_ma_us$age.group,
levels = c("Infants", "Adults"))
dat.fig_ma_us$phylum=sapply(dat.fig_ma_us$phylum, function(x) strsplit(x, "__")[[1]][2])
dat.fig_ma_us$phylum=factor(dat.fig_ma_us$phylum, levels = sort(unique(dat.fig_ma_us$phylum)))
dat.fig_ma_us$struc.zero=factor(dat.fig_ma_us$struc.zero)
ven_us_0_2=read_csv("../data/global_gut/ven_us_phylum_age2.csv")
ven_us_18_40=read_csv("../data/global_gut/ven_us_phylum_age18_40.csv")
ven_us_phyla=unique(c(ven_us_18_40$phylum, ven_us_0_2$phylum))
ven_us_0_2=ven_us_0_2%>%transmute(phylum, log.fold.change=`log fold change (VEN - US)`,
se=se, ci.lo=ci.lo.adj, ci.up=ci.up.adj,
struc.zero=ifelse(se==0, 1, 0),
q.val, age.group = "Infants",
star=ifelse(q.val<.001, "***",
ifelse(q.val<.01, "**",
ifelse(q.val<.05, "*", ""))))
if(length(setdiff(ven_us_phyla, ven_us_0_2$phylum))>0){
ven_us_0_2.1=data.frame(phylum=setdiff(ven_us_phyla, ven_us_0_2$phylum),
log.fold.change=0, se=0, ci.lo=0, ci.up=0,
struc.zero=1, q.val=1, age.group="Infants", star="")
ven_us_0_2=rbind(ven_us_0_2, ven_us_0_2.1)
}
ven_us_18_40=ven_us_18_40%>%transmute(phylum, log.fold.change=`log fold change (VEN - US)`,
se=se, ci.lo=ci.lo.adj, ci.up=ci.up.adj,
struc.zero=ifelse(se==0, 1, 0),
q.val, age.group = "Adults",
star=ifelse(q.val<.001, "***",
ifelse(q.val<.01, "**",
ifelse(q.val<.05, "*", ""))))
if(length(setdiff(ven_us_phyla, ven_us_18_40$phylum))>0){
ven_us_18_40.1=data.frame(phylum=setdiff(ven_us_phyla, ven_us_18_40$phylum),
log.fold.change=0, se=0, ci.lo=0, ci.up=0,
struc.zero=1, q.val=1, age.group="Adults", star="")
ven_us_18_40=rbind(ven_us_18_40, ven_us_18_40.1)
}
dat.fig_ven_us=rbind(ven_us_0_2, ven_us_18_40)
dat.fig_ven_us$age.group=factor(dat.fig_ven_us$age.group,
levels = c("Infants", "Adults"))
dat.fig_ven_us$phylum=sapply(dat.fig_ven_us$phylum, function(x) strsplit(x, "__")[[1]][2])
dat.fig_ven_us$phylum=factor(dat.fig_ven_us$phylum, levels = sort(unique(dat.fig_ven_us$phylum)))
dat.fig_ven_us$struc.zero=factor(dat.fig_ven_us$struc.zero)
ma_ven_0_2=read_csv("../data/global_gut/ma_ven_phylum_age2.csv")
ma_ven_18_40=read_csv("../data/global_gut/ma_ven_phylum_age18_40.csv")
ma_ven_phyla=unique(c(ma_ven_18_40$phylum, ma_ven_0_2$phylum))
ma_ven_0_2=ma_ven_0_2%>%transmute(phylum, log.fold.change=`log fold change (MA - VEN)`,
se=se, ci.lo=ci.lo.adj, ci.up=ci.up.adj,
struc.zero=ifelse(se==0, 1, 0),
q.val, age.group = "Infants",
star=ifelse(q.val<.001, "***",
ifelse(q.val<.01, "**",
ifelse(q.val<.05, "*", ""))))
if(length(setdiff(ma_ven_phyla, ma_ven_0_2$phylum))>0){
ma_ven_0_2.1=data.frame(phylum=setdiff(ma_ven_phyla, ma_ven_0_2$phylum),
log.fold.change=0, se=0, ci.lo=0, ci.up=0,
struc.zero=1, q.val=1, age.group="Infants", star="")
ma_ven_0_2=rbind(ma_ven_0_2, ma_ven_0_2.1)
}
ma_ven_18_40=ma_ven_18_40%>%transmute(phylum, log.fold.change=`log fold change (MA - VEN)`,
se=se, ci.lo=ci.lo.adj, ci.up=ci.up.adj,
struc.zero=ifelse(se==0, 1, 0),
q.val, age.group = "Adults",
star=ifelse(q.val<.001, "***",
ifelse(q.val<.01, "**",
ifelse(q.val<.05, "*", ""))))
if(length(setdiff(ma_ven_phyla, ma_ven_18_40$phylum))>0){
ma_ven_18_40.1=data.frame(phylum=setdiff(ma_ven_phyla, ma_ven_18_40$phylum),
log.fold.change=0, se=0, ci.lo=0, ci.up=0,
struc.zero=1, q.val=1, age.group="Adults", star="")
ma_ven_18_40=rbind(ma_ven_18_40, ma_ven_18_40.1)
}
dat.fig_ma_ven=rbind(ma_ven_0_2, ma_ven_18_40)
dat.fig_ma_ven$age.group=factor(dat.fig_ma_ven$age.group,
levels = c("Infants", "Adults"))
dat.fig_ma_ven$phylum=sapply(dat.fig_ma_ven$phylum, function(x) strsplit(x, "__")[[1]][2])
dat.fig_ma_ven$phylum=factor(dat.fig_ma_ven$phylum, levels = sort(unique(dat.fig_ma_ven$phylum)))
dat.fig_ma_ven$struc.zero=factor(dat.fig_ma_ven$struc.zero)
dat.fig_ma_us2=cbind(dat.fig_ma_us, type="MA - US")
dat.fig_ven_us2=cbind(dat.fig_ven_us, type="VEN - US")
dat.fig_ma_ven2=cbind(dat.fig_ma_ven, type="MA - VEN")
dat.fig_ma_ven2=dat.fig_ma_ven2[-which(dat.fig_ma_ven2$phylum%in%c("Acidobacteria", "Chloroflexi")), ]
dat.fig_ma_ven2$phylum=factor(dat.fig_ma_ven2$phylum)
dat.fig=rbind(dat.fig_ma_us2, dat.fig_ven_us2, dat.fig_ma_ven2)
dat.fig$type=factor(dat.fig$type, levels = c("MA - US", "VEN - US", "MA - VEN"))
p1=ggplot(dat.fig, aes(x=phylum, y=log.fold.change, ymin=ci.lo, ymax=ci.up, group=age.group)) +
geom_bar(aes(fill=age.group), stat="identity", width=0.4, position=position_dodge())+
geom_errorbar(width=0.2, size=0.25, position=position_dodge(width = 0.4))+
geom_abline(slope = 0, intercept = 0, linetype="dashed", alpha=0.5)+
labs(x=NULL, y="Log Fold Change")+coord_flip()+
scale_fill_discrete(name=NULL)+
scale_x_discrete(limits = rev(levels(dat.fig$phylum)))+
facet_grid(.~type, scales = "free_x")+
theme_bw()+
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
strip.background = element_rect(fill="white"))+
geom_text(aes(y=log.fold.change+4*sign(log.fold.change), label=star),
vjust=.7, color="black", position=position_dodge(width = .5))
p1 = p1+geom_point(data = dat.fig%>%filter(struc.zero==1), aes(x=phylum, y=log.fold.change),
position=position_dodge(width = 0.4), shape=18)
ggarrange(p1, labels = "a")
# Bacteroidetes - Firmicutes
BFratio_summary = function(eval_data, country, age){
BFdiff=eval_data%>%dplyr::select(phylum, log.fold.change, se)%>%
filter(phylum%in%c("p__Bacteroidetes", "p__Firmicutes"))
diff_mean=BFdiff%>%filter(phylum == "p__Bacteroidetes")%>%.$log.fold.change-
BFdiff%>%filter(phylum == "p__Firmicutes")%>%.$log.fold.change
diff_se=sqrt(BFdiff%>%filter(phylum == "p__Bacteroidetes")%>%.$se%>%.^2+
BFdiff%>%filter(phylum == "p__Firmicutes")%>%.$se%>%.^2)
diff_p=2*pnorm(abs(diff_mean/diff_se), mean=0, sd=1, lower.tail = F)
ci_lo=diff_mean-1.96*diff_se
ci_up=diff_mean+1.96*diff_se
BFdiff=signif(c(diff_mean, diff_se, diff_p, ci_lo, ci_up), 2)
BFdiff=c(country, age, BFdiff)
return(BFdiff)
}
country.list = rep(c("MA - US", "VEN - US", "MA - VEN"), 2)
age.list = rep(c("Infants", "Adults"), each = 3)
eval.data.list = list(ma_us_0_2, ven_us_0_2, ma_ven_0_2, ma_us_18_40, ven_us_18_40, ma_ven_18_40)
BFres.list = vector(mode = "list", length = 6)
for (i in 1:6) {
country = country.list[i]
age = age.list[i]
eval.data = eval.data.list[[i]]
BFres.list[[i]] = BFratio_summary(eval.data, country, age)
}
BFres = as.data.frame(Reduce('rbind', BFres.list), stringsAsFactors = F)
rownames(BFres)=NULL
colnames(BFres)=c("country", "age", "log.fold.change", "se", "p.value", "ci.lo", "ci.up")
BFres$age = factor(BFres$age, levels = c("Infants", "Adults"))
dat.fig.diff=BFres
dat.fig.diff$log.fold.change=as.numeric(dat.fig.diff$log.fold.change)
dat.fig.diff$ci.lo=as.numeric(dat.fig.diff$ci.lo)
dat.fig.diff$ci.up=as.numeric(dat.fig.diff$ci.up)
dat.fig.diff$p.value=as.numeric(dat.fig.diff$p.value)
dat.fig.diff=dat.fig.diff%>%mutate(star=ifelse(p.value<.001, "***",
ifelse(p.value<.01, "**",
ifelse(p.value<.05, "*", ""))))
p2=ggplot(dat.fig.diff, aes(x=country, y=log.fold.change, ymin=ci.lo, ymax=ci.up, group=age)) +
geom_bar(aes(fill=age),
stat="identity", width=0.4, position=position_dodge())+
geom_errorbar(width=.2, size=.25, position=position_dodge(width = .4))+
geom_abline(slope = 0, intercept = 0, linetype="dashed", alpha=0.5)+
labs(x=NULL, y="Log Fold Change (Bacteroidetes - Firmicutes)")+coord_flip()+
scale_fill_discrete(name="")+
scale_x_discrete(limits = c("MA - VEN", "VEN - US", "MA - US"))+
theme_bw()+
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.border = element_rect(colour = "black"))+
geom_text(aes(y=log.fold.change+2.5*sign(log.fold.change), label=star),
vjust=.7, color="black", position=position_dodge(width = .5))
ggarrange(p2, labels = "b")
