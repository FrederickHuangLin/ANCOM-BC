---
title: "Figure S4, Table S4, S5, S6"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
rm(list = ls())

library(readxl)
library(tidyverse)
library(ggpubr)
library(pander)
panderOptions('table.caption.prefix', NULL)
panderOptions('table.continues', NULL)
panderOptions('table.emphasize.rownames', FALSE)

source("ancom_bc_v1.0.R")
source("sim_data_poi_gam_two_grp.R")
source("sim_data_poi_gam_multi_grp.R")

data_summary1 = function(eval_data){
  FDR=tapply(as.numeric(eval_data[1, ]), 
             rep(seq(nrow(simpattern)), each=iterNum), function(x) mean(x, na.rm = T))
  FDRSD=tapply(as.numeric(eval_data[1, ]), 
               rep(seq(nrow(simpattern)), each=iterNum), function(x) sd(x, na.rm = T))
  power=tapply(as.numeric(eval_data[2, ]), 
               rep(seq(nrow(simpattern)), each=iterNum), function(x) mean(x, na.rm = T))
  powerSD=tapply(as.numeric(eval_data[2, ]), 
                 rep(seq(nrow(simpattern)), each=iterNum), function(x) sd(x, na.rm = T))
  
  FDR=signif(FDR, 2); FDRSD=signif(FDRSD, 2)
  power=signif(power, 2); powerSD=signif(powerSD, 2)
  data_sum = data.frame(simpattern, FDR, FDRSD, power, powerSD, row.names = NULL)
  data_sum = data_sum%>%unite(n.samp.grp, n.samp.grp1, n.samp.grp2, sep = "/")%>%
    mutate(prop.diff=prop.diff*100)
  
  return(data_sum)
}

data_summary2 = function(eval_data){
  FDR=tapply(as.numeric(eval_data[1, ]), 
             rep(seq(nrow(simpattern)), each=iterNum), function(x) mean(x, na.rm = T))
  FDRSD=tapply(as.numeric(eval_data[1, ]), 
               rep(seq(nrow(simpattern)), each=iterNum), function(x) sd(x, na.rm = T))
  power=tapply(as.numeric(eval_data[2, ]), 
               rep(seq(nrow(simpattern)), each=iterNum), function(x) mean(x, na.rm = T))
  powerSD=tapply(as.numeric(eval_data[2, ]), 
                 rep(seq(nrow(simpattern)), each=iterNum), function(x) sd(x, na.rm = T))
  
  FDR=signif(FDR, 2); FDRSD=signif(FDRSD, 2)
  power=signif(power, 2); powerSD=signif(powerSD, 2)
  data_sum = data.frame(simpattern, FDR, FDRSD, power, powerSD, row.names = NULL)
  data_sum = data_sum%>%mutate(prop.diff=prop.diff*100,
                               n.samp.grp=gsub(" ", "/", n.samp.grp))
  
  return(data_sum)
}
```

# 1. Small Sample Sizes

## 1.1 Simulation settings

```{r, message=FALSE, warning=FALSE, comment=NA}
# The number of taxa, samping fraction variability, and sample size
n.taxa=500; samp.frac.var="large"; n.samp=c("5_5", "10_10")

# The proportion of differentially abundant taxa
prop.diff=c(0.05, 0.15, 0.25)

# Set seeds
iterNum=100
abn.seed=seq(iterNum)

# Define the simulation parameters combinations
simparams=expand.grid(n.taxa, n.samp, prop.diff, abn.seed, samp.frac.var)
colnames(simparams)=c("n.taxa", "n.samp", "prop.diff", "abn.seed", "samp.frac.var")
simparams=simparams%>%mutate(obs.seed=abn.seed+1)
simparams=simparams%>%separate(col = n.samp, into = c("n.samp.grp1", "n.samp.grp2"), sep = "_")
simparams$n.samp.grp1=as.numeric(simparams$n.samp.grp1)
simparams$n.samp.grp2=as.numeric(simparams$n.samp.grp2)
simparams=simparams%>%arrange(n.taxa, n.samp.grp1, prop.diff, abn.seed, obs.seed)
simparams.list=apply(simparams, 1, paste0, collapse="_")

simparamslabels=c("n.taxa", "n.samp.grp1", "n.samp.grp2","prop.diff", 
                  "abn.seed", "samp.frac.var", "obs.seed")
```

## 1.2 Run simulations

```{r, message=FALSE, warning=FALSE, comment=NA, eval=FALSE}
library(doParallel)
library(foreach)

detectCores()
myCluster=makeCluster(2, type = "FORK")
registerDoParallel(myCluster)

start_time <- Sys.time()
simlist=foreach(i = simparams.list, .combine = 'cbind') %dopar% {
  # i = simparams.list[[1]]
  print(i)
  params = strsplit(i, "_")[[1]]
  names(params) <- simparamslabels
  
  # Paras for data generation
  n.taxa=as.numeric(params["n.taxa"])
  n.samp.grp1=as.numeric(params["n.samp.grp1"])
  n.samp.grp2=as.numeric(params["n.samp.grp2"])
  prop.diff=as.numeric(params["prop.diff"])
  abn.seed=as.numeric(params["abn.seed"])
  obs.seed=as.numeric(params["obs.seed"])
  samp.frac.var=params["samp.frac.var"]
  
  # Data generation
  low.abn=50; med.abn=200; high.abn=10000; struc.zero.prop=0.2; out.zero.prop=0.05
  test.dat=abn.tab.gen1(n.taxa, n.samp.grp1, n.samp.grp2, low.abn, med.abn, high.abn,
                        prop.diff, abn.seed, obs.seed, struc.zero.prop, out.zero.prop, samp.frac.var)
  obs.abn=test.dat$obs.abn
  meta.data=cbind(Sample.ID=paste0("sub", seq(n.samp.grp1+n.samp.grp2)), 
                  group=rep(c(1, 2), c(n.samp.grp1, n.samp.grp2)))
  
  # Pre-processing
  feature.table=obs.abn; sample.var="Sample.ID"; group.var="group"; 
  zero.cut=0.90; lib.cut=1000; neg.lb=FALSE
  pre.process=feature_table_pre_process(feature.table, meta.data, sample.var, 
                                        group.var, zero.cut, lib.cut, neg.lb)
  feature.table=pre.process$feature.table
  group.name=pre.process$group.name
  group.ind=pre.process$group.ind
  struc.zero=pre.process$structure.zeros
  
  # Paras for ANCOM-BC
  grp.name=group.name; grp.ind=group.ind; adj.method="bonferroni"
  tol.EM=1e-5; max.iterNum=100; perNum=1000; alpha=0.05
  
  # Run ANCOM-BC
  suppressWarnings(out <- try(ANCOM_BC(feature.table, grp.name, grp.ind, struc.zero,
                                       adj.method, tol.EM, max.iterNum, perNum, alpha), 
                              silent = TRUE))
  if (inherits(out, "try-error")) {
    FDR=NA; power=NA
  }else{
    res=cbind(out$res, diff.ind=test.dat$diff.taxa[rownames(out$feature.table)])
    
    # FDR
    FDR=ifelse(sum(res$diff.abn, na.rm = T)==0, 0, 
               sum(ifelse(res$diff.ind==0&res$diff.abn, 1, 0), na.rm = T)/
                 sum(res$diff.abn, na.rm = T))
    
    # Power
    power=sum(ifelse(res$diff.ind!=0&res$diff.abn, 1, 0), na.rm = T)/
      sum(res$diff.ind!=0, na.rm = T)
  }
  c(FDR, power)
}
end_time <- Sys.time()
end_time - start_time

stopCluster(myCluster)
write_csv(data.frame(simlist), "fdr_power_small_samp_ancom_bc.csv")
```

## 1.3 FDR and Power

```{r, message=FALSE, warning=FALSE, comment=NA}
dat.small.samp=read_csv("../data/sim_additional/fdr_power_small_samp_ancom_bc.csv")

## Reshaping data
simpattern=distinct(simparams, n.taxa, n.samp.grp1, n.samp.grp2, prop.diff)

sum.small.samp=data_summary1(dat.small.samp)
colnames(sum.small.samp)=c("# Taxa", "Sample Size", "Diff (%)", "FDR", "FDRSD", "Power", "PowerSD")
```

## 1.4 Table S4

```{r, message=FALSE, warning=FALSE, comment=NA}
pander(sum.small.samp)
```

# 2. Small Number of Taxa

## 2.1 Analogous to phylum level

### 2.11 Simulation settings

```{r, message=FALSE, warning=FALSE, comment=NA}
# The number of taxa, samping fraction variability, and sample size
n.taxa=10; samp.frac.var="large"; n.samp=c("20_30", "50_50")

# The proportion of differentially abundant taxa
prop.diff=0.25

# Set seeds
iterNum=100
abn.seed=seq(iterNum)

# Define the simulation parameters combinations
simparams=expand.grid(n.taxa, n.samp, prop.diff, abn.seed, samp.frac.var)
colnames(simparams)=c("n.taxa", "n.samp", "prop.diff", "abn.seed", "samp.frac.var")
simparams=simparams%>%mutate(obs.seed=abn.seed+1)
simparams=simparams%>%separate(col = n.samp, into = c("n.samp.grp1", "n.samp.grp2"), sep = "_")
simparams$n.samp.grp1=as.numeric(simparams$n.samp.grp1)
simparams$n.samp.grp2=as.numeric(simparams$n.samp.grp2)
simparams=simparams%>%arrange(n.taxa, n.samp.grp1, prop.diff, abn.seed, obs.seed)
simparams.list=apply(simparams, 1, paste0, collapse="_")

simparamslabels=c("n.taxa", "n.samp.grp1", "n.samp.grp2","prop.diff", 
                  "abn.seed", "samp.frac.var", "obs.seed")
```

### 2.12 Run simulations

```{r, message=FALSE, warning=FALSE, comment=NA, eval=FALSE}
library(doParallel)
library(foreach)

detectCores()
myCluster=makeCluster(2, type = "FORK")
registerDoParallel(myCluster)

start_time <- Sys.time()
simlist=foreach(i = simparams.list, .combine = 'cbind') %dopar% {
  # i = simparams.list[[1]]
  print(i)
  params = strsplit(i, "_")[[1]]
  names(params) <- simparamslabels
  
  # Paras for data generation
  n.taxa=as.numeric(params["n.taxa"])
  n.samp.grp1=as.numeric(params["n.samp.grp1"])
  n.samp.grp2=as.numeric(params["n.samp.grp2"])
  prop.diff=as.numeric(params["prop.diff"])
  abn.seed=as.numeric(params["abn.seed"])
  obs.seed=as.numeric(params["obs.seed"])
  samp.frac.var=params["samp.frac.var"]
  
  # Data generation
  low.abn=5000; med.abn=20000; high.abn=1000000; struc.zero.prop=0; out.zero.prop=0
  test.dat=abn.tab.gen1(n.taxa, n.samp.grp1, n.samp.grp2, low.abn, med.abn, high.abn,
                        prop.diff, abn.seed, obs.seed, struc.zero.prop, out.zero.prop, samp.frac.var)
  obs.abn=test.dat$obs.abn
  meta.data=cbind(Sample.ID=paste0("sub", seq(n.samp.grp1+n.samp.grp2)), 
                  group=rep(c(1, 2), c(n.samp.grp1, n.samp.grp2)))
  
  # Pre-processing
  feature.table=obs.abn; sample.var="Sample.ID"; group.var="group"
  zero.cut=0.90; lib.cut=1000; neg.lb=FALSE
  pre.process=feature_table_pre_process(feature.table, meta.data, sample.var, 
                                        group.var, zero.cut, lib.cut, neg.lb)
  feature.table=pre.process$feature.table
  group.name=pre.process$group.name
  group.ind=pre.process$group.ind
  struc.zero=pre.process$structure.zeros
  
  # Paras for ANCOM-BC
  grp.name=group.name; grp.ind=group.ind; adj.method="bonferroni"
  tol.EM=1e-5; max.iterNum=100; perNum=1000; alpha=0.05
  
  # Run ANCOM-BC
  suppressWarnings(out <- try(ANCOM_BC(feature.table, grp.name, grp.ind, struc.zero,
                                       adj.method, tol.EM, max.iterNum, perNum, alpha), 
                              silent = TRUE))
  if (inherits(out, "try-error")) {
    FDR=NA; power=NA
  }else{
    res=cbind(out$res, diff.ind=test.dat$diff.taxa[rownames(out$feature.table)])
    
    # FDR
    FDR=ifelse(sum(res$diff.abn, na.rm = T)==0, 0, 
               sum(ifelse(res$diff.ind==0&res$diff.abn, 1, 0), na.rm = T)/
                 sum(res$diff.abn, na.rm = T))
    
    # Power
    power=sum(ifelse(res$diff.ind!=0&res$diff.abn, 1, 0), na.rm = T)/
      sum(res$diff.ind!=0, na.rm = T)
  }
  c(FDR, power)
}
end_time <- Sys.time()
end_time - start_time

stopCluster(myCluster)
write_csv(data.frame(simlist1), "fdr_power_small_taxa_ancom_bc_1.csv")
```

### 2.13 FDR and Power

```{r, message=FALSE, warning=FALSE, comment=NA}
dat.small.taxa1=read_csv("../data/sim_additional/fdr_power_small_taxa_ancom_bc_1.csv")

## Reshaping data
simpattern=distinct(simparams, n.taxa, n.samp.grp1, n.samp.grp2, prop.diff)
sum.small.taxa1=data_summary1(dat.small.taxa1)
```

## 2.2 Analogous to class/order level

### 2.21 Simulation settings

```{r, message=FALSE, warning=FALSE, comment=NA}
# The number of taxa, samping fraction variability, and sample size
n.taxa=50; samp.frac.var="large"; n.samp=c("20_30", "50_50")

# The proportion of differentially abundant taxa
prop.diff=0.25

# Set seeds
iterNum=100
abn.seed=seq(iterNum)

# Define the simulation parameters combinations
simparams=expand.grid(n.taxa, n.samp, prop.diff, abn.seed, samp.frac.var)
colnames(simparams)=c("n.taxa", "n.samp", "prop.diff", "abn.seed", "samp.frac.var")
simparams=simparams%>%mutate(obs.seed=abn.seed+1)
simparams=simparams%>%separate(col = n.samp, into = c("n.samp.grp1", "n.samp.grp2"), sep = "_")
simparams$n.samp.grp1=as.numeric(simparams$n.samp.grp1)
simparams$n.samp.grp2=as.numeric(simparams$n.samp.grp2)
simparams=simparams%>%arrange(n.taxa, n.samp.grp1, prop.diff, abn.seed, obs.seed)
simparams.list=apply(simparams, 1, paste0, collapse="_")

simparamslabels=c("n.taxa", "n.samp.grp1", "n.samp.grp2","prop.diff", 
                  "abn.seed", "samp.frac.var", "obs.seed")
```

### 2.22 Run simulations

```{r, message=FALSE, warning=FALSE, comment=NA, eval=FALSE}
library(doParallel)
library(foreach)

detectCores()
myCluster=makeCluster(2, type = "FORK")
registerDoParallel(myCluster)

start_time <- Sys.time()
simlist=foreach(i = simparams.list, .combine = 'cbind') %dopar% {
  # i = simparams.list[[1]]
  print(i)
  params = strsplit(i, "_")[[1]]
  names(params) <- simparamslabels
  
  # Paras for data generation
  n.taxa=as.numeric(params["n.taxa"])
  n.samp.grp1=as.numeric(params["n.samp.grp1"])
  n.samp.grp2=as.numeric(params["n.samp.grp2"])
  prop.diff=as.numeric(params["prop.diff"])
  abn.seed=as.numeric(params["abn.seed"])
  obs.seed=as.numeric(params["obs.seed"])
  samp.frac.var=params["samp.frac.var"]
  
  # Data generation
  low.abn=500; med.abn=2000; high.abn=100000; struc.zero.prop=0; out.zero.prop=0
  test.dat=abn.tab.gen1(n.taxa, n.samp.grp1, n.samp.grp2, low.abn, med.abn, high.abn,
                        prop.diff, abn.seed, obs.seed, struc.zero.prop, out.zero.prop, samp.frac.var)
  obs.abn=test.dat$obs.abn
  meta.data=cbind(Sample.ID=paste0("sub", seq(n.samp.grp1+n.samp.grp2)), 
                  group=rep(c(1, 2), c(n.samp.grp1, n.samp.grp2)))
  
  # Pre-processing
  feature.table=obs.abn; sample.var="Sample.ID"; group.var="group"
  zero.cut=0.90; lib.cut=1000; neg.lb=FALSE
  pre.process=feature_table_pre_process(feature.table, meta.data, sample.var, 
                                        group.var, zero.cut, lib.cut, neg.lb)
  feature.table=pre.process$feature.table
  group.name=pre.process$group.name
  group.ind=pre.process$group.ind
  struc.zero=pre.process$structure.zeros
  
  # Paras for ANCOM-BC
  grp.name=group.name; grp.ind=group.ind; adj.method="bonferroni"
  tol.EM=1e-5; max.iterNum=100; perNum=1000; alpha=0.05
  
  # Run ANCOM-BC
  suppressWarnings(out <- try(ANCOM_BC(feature.table, grp.name, grp.ind, struc.zero,
                                       adj.method, tol.EM, max.iterNum, perNum, alpha), 
                              silent = TRUE))
  if (inherits(out, "try-error")) {
    FDR=NA; power=NA
  }else{
    res=cbind(out$res, diff.ind=test.dat$diff.taxa[rownames(out$feature.table)])
    
    # FDR
    FDR=ifelse(sum(res$diff.abn, na.rm = T)==0, 0, 
               sum(ifelse(res$diff.ind==0&res$diff.abn, 1, 0), na.rm = T)/
                 sum(res$diff.abn, na.rm = T))
    
    # Power
    power=sum(ifelse(res$diff.ind!=0&res$diff.abn, 1, 0), na.rm = T)/
      sum(res$diff.ind!=0, na.rm = T)
  }
  c(FDR, power)
}
end_time <- Sys.time()
end_time - start_time

stopCluster(myCluster)
write_csv(data.frame(simlist1), "fdr_power_small_taxa_ancom_bc_2.csv")
```

### 2.23 FDR and Power

```{r, message=FALSE, warning=FALSE, comment=NA}
dat.small.taxa2=read_csv("../data/sim_additional/fdr_power_small_taxa_ancom_bc_2.csv")

## Reshaping data
simpattern=distinct(simparams, n.taxa, n.samp.grp1, n.samp.grp2, prop.diff)
sum.small.taxa2=data_summary1(dat.small.taxa2)
```

## 2.3 Table S5

```{r, message=FALSE, warning=FALSE, comment=NA}
sum.small.taxa = rbind(sum.small.taxa1, sum.small.taxa2)
colnames(sum.small.taxa)=c("# Taxa", "Sample Size", "Diff (%)", "FDR", "FDRSD", "Power", "PowerSD")

pander(sum.small.taxa)
```

# 3. Multi-Group Comparison

## 3.1 Simulation settings

```{r, message=FALSE, warning=FALSE, comment=NA}
# The number of taxa, samping fraction variability, and sample size
n.taxa=1000; n.samp.grp=c("20 20 30 30", "50 50 50 50")

# The proportion of differentially abundant taxa
prop.diff=c(0.05, 0.15, 0.25)

# Set seeds
iterNum=100
abn.seed=seq(iterNum)

# Define the simulation parameters combinations
simparams=expand.grid(n.taxa, n.samp.grp, prop.diff, abn.seed)
colnames(simparams)=c("n.taxa", "n.samp.grp", "prop.diff", "abn.seed")
simparams=simparams%>%mutate(obs.seed=abn.seed+1)
simparams=simparams%>%arrange(n.taxa, n.samp.grp, prop.diff, abn.seed, obs.seed)
simparams.list=apply(simparams, 1, paste0, collapse="_")

simparamslabels=c("n.taxa", "n.samp.grp", "prop.diff", "abn.seed", "obs.seed")
```

## 3.2 Run simulations

```{r, message=FALSE, warning=FALSE, comment=NA, eval=FALSE}
library(doParallel)
library(foreach)

detectCores()
myCluster=makeCluster(10, type = "FORK")
registerDoParallel(myCluster)

start_time <- Sys.time()
simlist=foreach(i = simparams.list, .combine = 'cbind') %dopar% {
  # i = simparams.list[[1]]
  print(i)
  params = strsplit(i, "_")[[1]]
  names(params) <- simparamslabels
  
  # Paras for data generation
  n.taxa=as.numeric(params["n.taxa"])
  n.samp.grp=as.numeric(str_split(params["n.samp.grp"], " ")[[1]])
  prop.diff=as.numeric(params["prop.diff"])
  abn.seed=as.numeric(params["abn.seed"])
  obs.seed=as.numeric(params["obs.seed"])
  
  # Data generation
  low.abn=50; med.abn=200; high.abn=10000; struc.zero.prop=0.2; out.zero.prop=0.05
  test.dat=abn.tab.gen2(n.taxa, n.samp.grp, low.abn, med.abn, high.abn,
                        prop.diff, abn.seed, obs.seed, struc.zero.prop, out.zero.prop)
  obs.abn=test.dat$obs.abn
  meta.data=cbind(Sample.ID=paste0("sub", seq(sum(n.samp.grp))), 
                  group=rep(c(1:length(n.samp.grp)), n.samp.grp))
  
  # Pre-processing
  feature.table=obs.abn; sample.var="Sample.ID"; group.var="group";
  zero.cut=0.90; lib.cut=1000; neg.lb=FALSE
  pre.process=feature_table_pre_process(feature.table, meta.data, sample.var, 
                                        group.var, zero.cut, lib.cut, neg.lb)
  feature.table=pre.process$feature.table
  group.name=pre.process$group.name
  group.ind=pre.process$group.ind
  struc.zero=pre.process$structure.zeros
  
  # Paras for ANCOM-BC
  grp.name=group.name; grp.ind=group.ind; adj.method="bonferroni"
  tol.EM=1e-5; max.iterNum=100; perNum=1000; alpha=0.05
  
  # Run ANCOM-BC
  suppressWarnings(out <- try(ANCOM_BC(feature.table, grp.name, grp.ind, struc.zero,
                                       adj.method, tol.EM, max.iterNum, perNum, alpha), 
                              silent = TRUE))
  if (inherits(out, "try-error")) {
    FDR=NA; power=NA
  }else{
    res=cbind(out$res, diff.ind=test.dat$diff.taxa[rownames(out$feature.table)])
    
    # FDR
    FDR=ifelse(sum(res$diff.abn, na.rm = T)==0, 0, 
               sum(ifelse(res$diff.ind==0&res$diff.abn, 1, 0), na.rm = T)/
                 sum(res$diff.abn, na.rm = T))
    
    # Power
    power=sum(ifelse(res$diff.ind!=0&res$diff.abn, 1, 0), na.rm = T)/
      sum(res$diff.ind!=0, na.rm = T)
  }
  c(FDR, power)
}
end_time <- Sys.time()
end_time - start_time

stopCluster(myCluster)
write_csv(data.frame(simlist), "fdr_power_multi_ancom_bc.csv")
```

## 3.3 FDR and Power

```{r, message=FALSE, warning=FALSE, comment=NA}
dat.multi=read_csv("../data/sim_additional/fdr_power_multi_ancom_bc.csv")

## Reshaping data
simpattern=distinct(simparams, n.taxa, n.samp.grp, prop.diff)

sum.multi=data_summary2(dat.multi)
colnames(sum.multi)=c("# Taxa", "Sample Size", "Diff (%)", "FDR", "FDRSD", "Power", "PowerSD")
```

## 3.4 Table S6

```{r, message=FALSE, warning=FALSE, comment=NA}
pander(sum.multi)
```


# 4. Highly Variable Microbial Environment

## 4.1 Simulation settings

```{r, message=FALSE, warning=FALSE, comment=NA}
# The number of taxa, samping fraction variability, and sample size
n.taxa=500; samp.frac.var="large"; n.samp=c("20_30", "50_50")

# The proportion of differentially abundant taxa
prop.diff=c(0.05, 0.15, 0.25, 0.55, 0.65, 0.75)

# Set seeds
iterNum=100
abn.seed=seq(iterNum)

# Define the simulation parameters combinations
simparams=expand.grid(n.taxa, n.samp, prop.diff, abn.seed, samp.frac.var)
colnames(simparams)=c("n.taxa", "n.samp", "prop.diff", "abn.seed", "samp.frac.var")
simparams=simparams%>%mutate(obs.seed=abn.seed+1)
simparams=simparams%>%separate(col = n.samp, into = c("n.samp.grp1", "n.samp.grp2"), sep = "_")
simparams=simparams%>%arrange(n.taxa, n.samp.grp1, prop.diff, abn.seed, obs.seed)
simparams.list=apply(simparams, 1, paste0, collapse="_")

simparamslabels=c("n.taxa", "n.samp.grp1", "n.samp.grp2","prop.diff", 
                  "abn.seed", "samp.frac.var", "obs.seed")
```

## 4.3 Run simulations

```{r, message=FALSE, warning=FALSE, comment=NA, eval=FALSE}
library(doParallel)
library(foreach)

detectCores()
myCluster=makeCluster(10, type = "FORK")
registerDoParallel(myCluster)

start_time <- Sys.time()
simlist=foreach(i = simparams.list, .combine = 'cbind') %dopar% {
  # i = simparams.list[[1]]
  print(i)
  params = strsplit(i, "_")[[1]]
  names(params) <- simparamslabels
  
  # Paras for data generation
  n.taxa=as.numeric(params["n.taxa"])
  n.samp.grp1=as.numeric(params["n.samp.grp1"])
  n.samp.grp2=as.numeric(params["n.samp.grp2"])
  prop.diff=as.numeric(params["prop.diff"])
  abn.seed=as.numeric(params["abn.seed"])
  obs.seed=as.numeric(params["obs.seed"])
  samp.frac.var=params["samp.frac.var"]
  
  # Data generation
  low.abn=50; med.abn=200; high.abn=10000; struc.zero.prop=0.2; out.zero.prop=0.05
  test.dat=abn.tab.gen1(n.taxa, n.samp.grp1, n.samp.grp2, low.abn, med.abn, high.abn,
                        prop.diff, abn.seed, obs.seed, struc.zero.prop, out.zero.prop, samp.frac.var)
  obs.abn=test.dat$obs.abn
  meta.data=cbind(Sample.ID=paste0("sub", seq(sum(n.samp.grp))), 
                  group=rep(c(1:length(n.samp.grp)), n.samp.grp))
  
  # Pre-processing
  feature.table=obs.abn; sample.var="Sample.ID"; group.var="group"; 
  zero.cut=0.90; lib.cut=1000; neg.lb=FALSE
  pre.process=feature_table_pre_process(feature.table, meta.data, sample.var, 
                                        group.var, zero.cut, lib.cut, neg.lb)
  feature.table=pre.process$feature.table
  group.name=pre.process$group.name
  group.ind=pre.process$group.ind
  struc.zero=pre.process$structure.zeros
  
  # Paras for ANCOM-BC
  grp.name=group.name; grp.ind=group.ind; adj.method="bonferroni"
  tol.EM=1e-5; max.iterNum=100; perNum=1000; alpha=0.05
  
  # Run ANCOM-BC
  suppressWarnings(out <- try(ANCOM_BC(feature.table, grp.name, grp.ind, struc.zero,
                                       adj.method, tol.EM, max.iterNum, perNum, alpha), 
                              silent = TRUE))
  if (inherits(out, "try-error")) {
    FDR=NA; power=NA
  }else{
    res=cbind(out$res, diff.ind=test.dat$diff.taxa[rownames(out$feature.table)])
    
    # FDR
    FDR=ifelse(sum(res$diff.abn, na.rm = T)==0, 0, 
               sum(ifelse(res$diff.ind==0&res$diff.abn, 1, 0), na.rm = T)/
                 sum(res$diff.abn, na.rm = T))
    
    # Power
    power=sum(ifelse(res$diff.ind!=0&res$diff.abn, 1, 0), na.rm = T)/
      sum(res$diff.ind!=0, na.rm = T)
  }
  c(FDR, power)
}
end_time <- Sys.time()
end_time - start_time

stopCluster(myCluster)
write_csv(data.frame(simlist), "fdr_power_high_diff_ancom_bc.csv")
```

## 4.4 FDR and Power

```{r, message=FALSE, warning=FALSE, comment=NA}
dat.high.approx=read_csv("../data/sim_additional/fdr_power_high_ancom_bc_approx.csv")
dat.high.mode1=read_csv("../data/sim_additional/fdr_power_high_ancom_bc_mode_1.csv")
dat.high.mode2=read_csv("../data/sim_additional/fdr_power_high_ancom_bc_mode_2.csv")

## Reshaping data
simpattern=distinct(simparams, n.taxa, n.samp.grp1, n.samp.grp2, prop.diff)

sum.high.approx=data_summary1(dat.high.approx)
sum.high.mode1=data_summary1(dat.high.mode1)
sum.high.mode2=data_summary1(dat.high.mode2)
dat.fig=data.frame(method=rep(c("Approximate", "Moderated (Bonferroni)", "Moderated (BH)"), 
                              each=nrow(simpattern)),
                   rbind(sum.high.approx, sum.high.mode1, sum.high.mode2))
dat.fig$prop.diff=factor(dat.fig$prop.diff, levels = c("5", "15", "25", "55", "65", "75"))
```

## 4.5 Fig. S4a

```{r, message=FALSE, warning=FALSE, comment=NA}
p=ggplot(dat.fig, aes(x=prop.diff, y=FDR, fill=method)) +
  geom_hline(yintercept=0.05, linetype="dashed", color="black", size = 0.2)+
  scale_y_continuous(breaks = c(0.05, 0.1, 0.15), limits = c(0, 0.15))+
  coord_flip()+facet_grid(.~n.samp.grp)+
  geom_bar(stat="identity", position=position_dodge())+
  labs(x="Proportion of Differentially Abundant Taxa", y="", fill=NULL, title="FDR")+
  scale_fill_brewer(palette="Dark2")+
  theme_bw()+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        strip.background = element_rect(fill="white"),
        plot.title=element_text(hjust = 0.5),
        legend.position = "bottom")
ggarrange(p, labels = "a")
ggsave("../figures/Figure S4a.pdf", width=6.25, height=5, units='in')
ggsave("../figures/Figure S4a.jpeg", width=6.25, height=5, units='in', dpi = 300)
```

## 4.6 Fig. S4b

```{r, message=FALSE, warning=FALSE, comment=NA}
p=ggplot(dat.fig, aes(x=prop.diff, y=power, fill=method)) +
  scale_y_continuous(breaks = seq(0.2, 1, 0.2), limits = c(0, 1))+
  coord_flip()+facet_grid(.~n.samp.grp)+
  geom_bar(stat="identity", position=position_dodge())+
  labs(x="Proportion of Differentially Abundant Taxa", y="", fill=NULL, title="Power")+
  scale_fill_brewer(palette="Dark2")+
  theme_bw()+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        strip.background = element_rect(fill="white"),
        plot.title=element_text(hjust = 0.5),
        legend.position = "bottom")
ggarrange(p, labels = "b")
ggsave("../figures/Figure S4b.pdf", width=6.25, height=5, units='in')
ggsave("../figures/Figure S4b.jpeg", width=6.25, height=5, units='in', dpi = 300)
```

## 4.5 Table S6

```{r, message=FALSE, warning=FALSE, comment=NA}
pander(sum.high.diff)
```


# Session information

```{r, message=FALSE, warning=FALSE, comment=NA}
sessionInfo()
devtools::session_info()
```

